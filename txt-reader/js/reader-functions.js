let readerSettingsDB;let chapterList;let content;let bookName='';let encodedBookName='';let readerChapters=[];let readerCurrentChapterIndex=0;function saveReadingPosition(chapterIndex,scrollTop){if(readerSettingsDB&&bookName){const positionData={bookName:encodedBookName,position:{chapterIndex:chapterIndex,scrollTop:scrollTop}};window.indexedDBHelper.updateData('readingPositions','positions',positionData).catch(error=>{console.error('保存阅读位置失败:',error)})}}function parseChapters(text){const chapterRegex=/^[\s#*$]*(第)?[零一二三四五六七八九十百千1234567890]+章.*$/gm;const matches=[];let match;let lastIndex=0;while((match=chapterRegex.exec(text))!==null){if(matches.length>0){matches[matches.length-1].content=text.slice(lastIndex,match.index)}matches.push({title:match[0],startIndex:match.index,content:''});lastIndex=match.index}if(matches.length>0){matches[matches.length-1].content=text.slice(lastIndex)}else{matches.push({title:'章节识别失败',content:text})}return matches}function renderChapters(chaptersData){readerChapters=chaptersData;chapterList.innerHTML='';if(readerSettingsDB){function readReadingPosition(){window.indexedDBHelper.getDataByKey('readingPositions','positions',encodedBookName).then(result=>{if(result&&result.position){const savedPosition=result.position;readerCurrentChapterIndex=savedPosition.chapterIndex;highlightChapter(readerCurrentChapterIndex);content.textContent=readerChapters[readerCurrentChapterIndex].content;content.scrollTop=savedPosition.scrollTop||0;updateWordCount(currentChapterIndex);const chapterItems=chapterList.querySelectorAll('div');if(chapterItems[currentChapterIndex]){chapterList.scrollTop=chapterItems[currentChapterIndex].offsetTop-200}}}).catch(error=>{setTimeout(readReadingPosition,100)})}readReadingPosition()}readerChapters.forEach((chapter,index)=>{const chapterDiv=document.createElement('div');chapterDiv.textContent=chapter.title;chapterDiv.classList.add('chapter-item');if(index===readerCurrentChapterIndex){chapterDiv.classList.add('active')}chapterDiv.addEventListener('click',()=>{readerCurrentChapterIndex=index;updateChapter(index)});chapterList.appendChild(chapterDiv)})}function renderContent(chapters){readerChapters=chapters;if(chapters.length>0){content.textContent=chapters[0].content;highlightChapter(0);updateWordCount(0)}content.addEventListener('scroll',debounce(()=>{const chapterIndex=Array.from(chapterList.querySelectorAll('div')).findIndex(item=>item.classList.contains('active'));if(chapterIndex!==-1){saveReadingPosition(chapterIndex,content.scrollTop)}const isAtBottom=content.scrollTop+content.clientHeight>=content.scrollHeight-10;const chapterButtons=document.getElementById('chapterButtons');if(chapterButtons){chapterButtons.style.display=isAtBottom?'flex':'none'}},300))}function debounce(func,wait){let timeout;return function(){const context=this;const args=arguments;clearTimeout(timeout);timeout=setTimeout(()=>{func.apply(context,args)},wait)}}function highlightChapter(index){const chapterItems=chapterList.querySelectorAll('div.chapter-item');chapterItems.forEach((item,i)=>{if(i===index){item.classList.add('active')}else{item.classList.remove('active')}})}function updateChapter(index){highlightChapter(index);content.textContent=readerChapters[index].content;updateWordCount(index);content.scrollTop=0;saveReadingPosition(index,0)}function initReaderFunctions(){chapterList=document.getElementById('chapterList');content=document.getElementById('content');const stores=[{name:'positions',keyPath:'bookName'}];window.indexedDBHelper.initDB('readingPositions',1,stores).then(db=>{readerSettingsDB=db}).catch(error=>{console.error('初始化阅读位置数据库失败:',error)});const progressBar=document.createElement('div');progressBar.id='progressBar';progressBar.style.cssText=`position:absolute;left:0;top:0;width:5px;background-color:#007bff;height:0%;transition:height 0.1s ease;z-index:100;`;content.parentNode.style.position='relative';content.parentNode.appendChild(progressBar);content.addEventListener('scroll',()=>{const scrollTop=content.scrollTop;const scrollHeight=content.scrollHeight-content.clientHeight;if(scrollHeight===0)return;const percentage=(scrollTop/scrollHeight)*100;progressBar.style.height=`${percentage}%`});const toggleBtn=document.getElementById('toggleChapters');if(toggleBtn){toggleBtn.addEventListener('click',()=>{const chapterList=document.getElementById('chapterList');if(chapterList){const isHidden=chapterList.style.display==='none';chapterList.style.display=isHidden?'block':'none';toggleBtn.textContent=isHidden?'▥':'▤';if(isHidden){const activeChapter=chapterList.querySelector('.active');if(activeChapter){activeChapter.scrollIntoView({behavior:'smooth',block:'nearest'})}}}})}document.getElementById('prevChapter').addEventListener('click',()=>{if(readerCurrentChapterIndex>0){readerCurrentChapterIndex--;updateChapter(readerCurrentChapterIndex)}});document.getElementById('nextChapter').addEventListener('click',()=>{if(readerCurrentChapterIndex<readerChapters.length-1){readerCurrentChapterIndex++;updateChapter(readerCurrentChapterIndex)}});document.addEventListener('keydown',function(e){if(e.altKey&&e.key==='r'){e.preventDefault();window.location.href='welcome.html'}});const prevChapterBottom=document.getElementById('prevChapterBottom');const nextChapterBottom=document.getElementById('nextChapterBottom');if(prevChapterBottom&&nextChapterBottom){prevChapterBottom.addEventListener('click',()=>{if(readerCurrentChapterIndex>0){readerCurrentChapterIndex--;updateChapter(readerCurrentChapterIndex)}});nextChapterBottom.addEventListener('click',()=>{if(readerCurrentChapterIndex<readerChapters.length-1){readerCurrentChapterIndex++;updateChapter(readerCurrentChapterIndex)}})}}function renderBookContentFromDB(bookData){if(typeof bookData==='string'){chapters=parseChapters(bookData)}else if(typeof bookData==='object'&&bookData.content){if(Array.isArray(bookData.content)){chapters=bookData.content.map(chapter=>({title:chapter.title,content:chapter.content}))}else if(typeof bookData.content==='string'){chapters=parseChapters(bookData.content)}else{console.error('书籍内容格式不正确:',typeof bookData.content);return}}else{console.error('无效的书籍数据格式');return}renderChapters(chapters);renderContent(chapters);if(typeof window.editHandler!=='undefined'&&typeof window.editHandler.initEditFunctionality==='function'){window.editHandler.initEditFunctionality(chapters,currentChapterIndex)}if(readerSettingsDB){window.indexedDBHelper.getDataByKey('readingPositions','positions',encodeURIComponent(bookName)).then(result=>{if(result&&result.position){const savedPosition=result.position;const{chapterIndex,scrollTop}=savedPosition;readerCurrentChapterIndex=chapterIndex;highlightChapter(chapterIndex);content.textContent=readerChapters[chapterIndex].content;content.scrollTop=scrollTop;const chapterItems=chapterList.querySelectorAll('div.chapter-item');if(chapterItems[chapterIndex]){chapterList.scrollTop=chapterItems[chapterIndex].offsetTop-200}}}).catch(error=>{console.error('读取阅读位置失败:',error)})}}if(typeof module!=='undefined'&&module.exports){module.exports={saveReadingPosition,parseChapters,renderChapters,renderContent,highlightChapter,updateChapter,initReaderFunctions,renderBookContentFromDB}}if(typeof window!=='undefined'){window.readerFunctions={saveReadingPosition,parseChapters,renderChapters,renderContent,highlightChapter,updateChapter,initReaderFunctions,renderBookContentFromDB}}
