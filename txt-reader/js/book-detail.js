let settingsDB,chapterList,content,currentChapterIndex=0,chapters=[],bookName="",encodedBookName="";function updateChapter(e){highlightChapter(e),content.textContent=chapters[e].content,updateWordCount(e),content.scrollTop=0,saveReadingPosition(e,0)}function saveReadingPosition(e,t){if(settingsDB&&bookName){settingsDB.transaction(["readingPositions"],"readwrite").objectStore("readingPositions").put({bookName:encodedBookName,position:{chapterIndex:e,scrollTop:t}})}}function parseChapters(e){const t=/^[\s#*$]*(第)?[零一二三四五六七八九十百千1234567890]+章.*$/gm,n=[];let o,i=0;for(;null!==(o=t.exec(e));)n.length>0&&(n[n.length-1].content=e.slice(i,o.index)),n.push({title:o[0],startIndex:o.index,content:""}),i=o.index;return n.length>0?n[n.length-1].content=e.slice(i):n.push({title:"章节识别失败",content:e}),n}function renderChapters(e){if(chapters=e,chapterList.innerHTML="",settingsDB){!function e(){try{const t=settingsDB.transaction(["readingPositions"],"readonly").objectStore("readingPositions").get(encodedBookName);t.onsuccess=function(){const e=t.result.position;if(e){highlightChapter(currentChapterIndex=e.chapterIndex),content.textContent=chapters[currentChapterIndex].content,content.scrollTop=e.scrollTop||0,updateWordCount(currentChapterIndex);const t=chapterList.querySelectorAll("div");t[currentChapterIndex]&&(chapterList.scrollTop=t[currentChapterIndex].offsetTop-200)}}}catch(t){setTimeout(e,100)}}()}chapters.forEach((e,t)=>{const n=document.createElement("div");n.textContent=e.title,n.classList.add("chapter-item"),t===currentChapterIndex&&n.classList.add("active"),n.addEventListener("click",()=>{currentChapterIndex=t,updateChapter(t)}),chapterList.appendChild(n)})}function renderContent(e){e.length>0&&(content.textContent=e[0].content,highlightChapter(0),updateWordCount(0)),content.addEventListener("scroll",debounce(()=>{const e=Array.from(chapterList.querySelectorAll("div")).findIndex(e=>e.classList.contains("active"));-1!==e&&saveReadingPosition(e,content.scrollTop);const t=content.scrollTop+content.clientHeight>=content.scrollHeight-10,n=document.getElementById("chapterButtons");n&&(n.style.display=t?"flex":"none")},300))}function debounce(e,t){let n;return function(){const o=this,i=arguments;clearTimeout(n),n=setTimeout(()=>{e.apply(o,i)},t)}}function highlightChapter(e){chapterList.querySelectorAll("div.chapter-item").forEach((t,n)=>{n===e?t.classList.add("active"):t.classList.remove("active")})}function updateWordCount(e){const t=chapters[e].content.trim().replace(/\s+/g,"").length,n=document.getElementById("chapterWordCount");n&&(n.textContent=`字数: ${t}`)}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("fileInput");chapterList=document.getElementById("chapterList"),content=document.getElementById("content");const e=document.createElement("div");e.id="progressBar",e.style.cssText="\n      position: absolute;\n      left: 0;\n      top: 0;\n      width: 5px;\n      background-color: #007bff;\n      height: 0%;\n      transition: height 0.1s ease;\n      z-index: 100;\n    ",content.parentNode.style.position="relative",content.parentNode.appendChild(e),content.addEventListener("scroll",()=>{const t=content.scrollTop,n=content.scrollHeight-content.clientHeight;if(0===n)return;const o=t/n*100;e.style.height=`${o}%`});const t=document.getElementById("lineHeight"),n=document.getElementById("fontSize"),o=document.getElementById("theme");document.getElementById("settingsToggle").addEventListener("click",()=>{const e=document.querySelector(".settings");e.style.display="none"===e.style.display?"flex":"none"});const i=indexedDB.open("userSettingsDB",1);function r(e){content.style.lineHeight=e.lineHeight,content.style.fontSize=e.fontSize,document.body.className=e.theme}i.onupgradeneeded=function(e){(settingsDB=e.target.result).objectStoreNames.contains("readingSettings")||settingsDB.createObjectStore("readingSettings",{keyPath:"id"}),settingsDB.objectStoreNames.contains("readingPositions")||settingsDB.createObjectStore("readingPositions",{keyPath:"bookName"})},i.onsuccess=function(e){settingsDB=e.target.result,function(){const e=settingsDB.transaction(["readingSettings"],"readonly").objectStore("readingSettings").get("globalSettings");e.onsuccess=function(){const i=e.result.settings||{};t.value=i.lineHeight||"1.6",n.value=i.fontSize||"1.125rem",o.value=i.theme||"light",r(i)}}()},i.onerror=function(e){console.error("用户设置数据库错误:",e.target.error)},t.addEventListener("change",()=>{const e={lineHeight:t.value,fontSize:n.value,theme:o.value};if(r(e),settingsDB){settingsDB.transaction(["readingSettings"],"readwrite").objectStore("readingSettings").put({id:"globalSettings",settings:e})}}),n.addEventListener("change",()=>{const e={lineHeight:t.value,fontSize:n.value,theme:o.value};if(r(e),settingsDB){settingsDB.transaction(["readingSettings"],"readwrite").objectStore("readingSettings").put({id:"globalSettings",settings:e})}}),o.addEventListener("change",()=>{const e={lineHeight:t.value,fontSize:n.value,theme:o.value};if(r(e),settingsDB){settingsDB.transaction(["readingSettings"],"readwrite").objectStore("readingSettings").put({id:"globalSettings",settings:e})}});const s=new URLSearchParams(window.location.search);bookName=decodeURIComponent(s.get("bookName")),encodedBookName=encodeURIComponent(bookName);const c=document.getElementById("txtTitle");c&&(c.textContent=bookName.replace(".txt","")||"txt在线阅读工具");const a=document.getElementById("toggleChapters");a&&a.addEventListener("click",()=>{const e=document.getElementById("chapterList");if(e){const t="none"===e.style.display;if(e.style.display=t?"block":"none",a.textContent=t?"▥":"▤",t){const t=e.querySelector(".active");t&&t.scrollIntoView({behavior:"smooth",block:"nearest"})}}}),document.getElementById("prevChapter").addEventListener("click",()=>{currentChapterIndex>0&&updateChapter(--currentChapterIndex)}),document.getElementById("nextChapter").addEventListener("click",()=>{currentChapterIndex<chapters.length-1&&updateChapter(++currentChapterIndex)}),document.addEventListener("keydown",function(e){e.altKey&&"r"===e.key&&(e.preventDefault(),window.location.href="welcome.html")});let d="";const l=document.getElementById("editChapter"),g=document.getElementById("saveChapterEdit"),p=document.getElementById("cancelChapterEdit"),u=document.getElementById("editControls"),h=document.getElementById("editStatus"),m=document.getElementById("content");function C(e,t){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){let n;n=t?`章节内容已保存至:\n${e}\n\n提示: 文件已保存到您选择的位置\n您可以通过文件管理器查找此文件`:`下载已启动，请检查默认下载文件夹:\n${e}\n\n提示: 传统下载方式无法确认保存状态，请确保:\n1. 浏览器允许来自此网站的下载\n2. 手机存储空间充足\n3. 查看浏览器默认下载路径\n\n故障排除:\n• 检查浏览器的"下载历史"页面\n• 在文件管理器中搜索"${e}"\n• 确认浏览器弹出窗口阻止设置未阻止下载\n• 尝试使用Chrome浏览器获得更好兼容性`,alert(n)}else alert(`章节内容已保存至默认下载文件夹:${e}\n\n提示: 现代浏览器支持选择保存位置，请使用Chrome、Edge或Firefox最新版本以获得更好体验。`)}l.addEventListener("click",()=>{d=m.textContent,m.contentEditable="true",m.classList.add("editing"),u.style.display="block",h.style.display="block",m.focus(),l.textContent="✍",l.disabled=!0}),p.addEventListener("click",()=>{m.textContent=d,m.contentEditable="false",m.classList.remove("editing"),u.style.display="none",h.style.display="none",l.textContent="✎",l.disabled=!1}),g.addEventListener("click",()=>{chapters[currentChapterIndex].content=m.textContent,updateWordCount(currentChapterIndex),m.contentEditable="false",m.classList.remove("editing"),u.style.display="none",h.style.display="none",l.textContent="✎",l.disabled=!1,async function(){let e=document.getElementById("content").innerText;if(!(e=(e=e.replace(/<br\s*\/?>/gi,"\n").replace(/<div>/gi,"\n").replace(/<\/div>/gi,"")).replace(/<[^>]*>/g,"").trim()))return void alert("无法保存空内容，请确保章节有文字内容后重试");const t=chapters[currentChapterIndex].title.replace(/[\\/:*?"<>|]/g,""),n=new Date,o=`${n.getFullYear()}${String(n.getMonth()+1).padStart(2,"0")}${String(n.getDate()).padStart(2,"0")}_${String(n.getHours()).padStart(2,"0")}${String(n.getMinutes()).padStart(2,"0")}${String(n.getSeconds()).padStart(2,"0")}`,i=`${t}+${o}.txt`;try{if(window.showSaveFilePicker){const t=await window.showSaveFilePicker({suggestedName:i,types:[{description:"Text Files",accept:{"text/plain":[".txt"]}}]}),n=await t.createWritable();await n.write(e),await n.close(),C(i,!0)}else{const t=new Blob([e],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=i,document.body.appendChild(o);const r=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});o.dispatchEvent(r),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(n)},5e3),C(i,!1)}}catch(e){console.error("文件保存失败:",e),alert(`文件保存失败: ${e.message}\n\n请尝试以下解决方法:\n1. 检查浏览器存储权限\n2. 确保手机存储空间充足\n3. 手动创建/txt文件夹后重试\n4. 确认章节内容不为空`)}}()});const y=document.getElementById("prevChapterBottom"),f=document.getElementById("nextChapterBottom");if(y&&f&&(y.addEventListener("click",()=>{currentChapterIndex>0&&updateChapter(--currentChapterIndex)}),f.addEventListener("click",()=>{currentChapterIndex<chapters.length-1&&updateChapter(++currentChapterIndex)})),bookName){const e=indexedDB.open("bookDB",1);e.onsuccess=function(e){const t=e.target.result.transaction(["books"],"readonly").objectStore("books").get(encodeURIComponent(bookName));t.onsuccess=function(){const e=t.result.content;if(console.log("bookName:",bookName),console.log("fileContent:",e?"存在":"不存在"),e){const t=parseChapters(e);if(renderChapters(t),renderContent(t),settingsDB){const e=settingsDB.transaction(["readingPositions"],"readonly").objectStore("readingPositions").get(encodeURIComponent(bookName));e.onsuccess=function(){const n=e.result.position;if(n){const{chapterIndex:e,scrollTop:o}=n;highlightChapter(e),content.textContent=t[e].content,content.scrollTop=o,updateWordCount(e);const i=chapterList.querySelectorAll("div");i[e]&&(chapterList.scrollTop=i[e].offsetTop-200)}}}}else alert("书籍内容不存在，请重新添加！"),content.textContent="书籍内容不存在，请返回书架重新添加！"}},e.onerror=function(e){console.error("获取文件内容失败:",e.target.error)}}});
