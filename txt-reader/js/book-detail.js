let settingsDB;document.addEventListener('DOMContentLoaded',()=>{const fileInput=document.getElementById('fileInput');if(typeof window.editHandler!=='undefined'){chapters=window.editHandler.chapters||[];currentChapterIndex=window.editHandler.currentChapterIndex||0}else{chapters=[];currentChapterIndex=0}if(typeof window.readerFunctions!=='undefined'&&typeof window.readerFunctions.initReaderFunctions==='function'){window.readerFunctions.initReaderFunctions()}if(typeof window.editHandler!=='undefined'&&typeof window.editHandler.initEditFunctionality==='function'){}const saveIndexdbEditButton=document.getElementById('saveIndexdbEdit');if(saveIndexdbEditButton){saveIndexdbEditButton.addEventListener('click',()=>{if(typeof window.editHandler!=='undefined'&&typeof window.editHandler.saveChapterToIndexedDB==='function'){window.editHandler.saveChapterToIndexedDB()}else{console.error('saveChapterToIndexedDB function is not available')}})}const settingsStores=[{name:'readingSettings',keyPath:'id'},{name:'readingPositions',keyPath:'bookName'}];window.indexedDBHelper.initDB('userSettingsDB',1,settingsStores).then(db=>{settingsDB=db;if(typeof initSettings!=='undefined'){initSettings(settingsDB,(settings)=>{if(typeof setupSettingsEventListeners!=='undefined'){setupSettingsEventListeners(settingsDB)}})}}).catch(error=>{console.error('用户设置数据库错误:',error)});const urlParams=new URLSearchParams(window.location.search);bookName=decodeURIComponent(urlParams.get('bookName'));encodedBookName=encodeURIComponent(bookName);const h1Element=document.getElementById('txtTitle');if(h1Element){h1Element.textContent=bookName.replace(".txt","")||'txt在线阅读工具'}if(bookName){const stores=[{name:'books',keyPath:'name'}];window.indexedDBHelper.initDB('bookDB',6,stores).then(db=>{return window.indexedDBHelper.getDataByKey('bookDB','books',encodeURIComponent(bookName))}).then(result=>{console.log('bookName:',bookName);console.log('bookData:',result?'存在':'不存在');if(result){if(typeof window.readerFunctions!=='undefined'){window.readerFunctions.renderBookContentFromDB(result)}else{const fileContent=result.content?(typeof result.content==='string'?result.content:result.content.map(chapter=>chapter.content).join('')):result;chapters=parseChapters(fileContent);renderChapters(chapters);renderContent(chapters);if(settingsDB){const transaction=settingsDB.transaction(['readingPositions'],'readonly');const store=transaction.objectStore('readingPositions');const getRequest=store.get(encodeURIComponent(bookName));getRequest.onsuccess=function(){const savedPosition=getRequest.result.position;if(savedPosition){const{chapterIndex,scrollTop}=savedPosition;highlightChapter(chapterIndex);content.textContent=chapters[chapterIndex].content;content.scrollTop=scrollTop;updateWordCount(chapterIndex);const chapterItems=chapterList.querySelectorAll('div');if(chapterItems[chapterIndex]){chapterList.scrollTop=chapterItems[chapterIndex].offsetTop-200}}}}}}else{alert('书籍内容不存在，请重新添加！');content.textContent='书籍内容不存在，请返回书架重新添加！'}}).catch(error=>{console.error('获取文件内容失败:',error)});function renderBookContent(fileContent){chapters=parseChapters(fileContent);renderChapters(chapters);renderContent(chapters);if(settingsDB){const transaction=settingsDB.transaction(['readingPositions'],'readonly');const store=transaction.objectStore('readingPositions');const getRequest=store.get(encodeURIComponent(bookName));getRequest.onsuccess=function(){const savedPosition=getRequest.result.position;if(savedPosition){const{chapterIndex,scrollTop}=savedPosition;highlightChapter(chapterIndex);content.textContent=chapters[chapterIndex].content;content.scrollTop=scrollTop;const chapterItems=chapterList.querySelectorAll('div.chapter-item');if(chapterItems[chapterIndex]){chapterList.scrollTop=chapterItems[chapterIndex].offsetTop-200}}}}}}});
