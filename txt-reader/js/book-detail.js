let settingsDB;document.addEventListener("DOMContentLoaded",()=>{document.getElementById("fileInput");void 0!==window.editHandler?(chapters=window.editHandler.chapters||[],currentChapterIndex=window.editHandler.currentChapterIndex||0):(chapters=[],currentChapterIndex=0),void 0!==window.readerFunctions&&"function"==typeof window.readerFunctions.initReaderFunctions&&window.readerFunctions.initReaderFunctions(),void 0!==window.editHandler&&window.editHandler.initEditFunctionality;const e=document.getElementById("saveIndexdbEdit");e&&e.addEventListener("click",()=>{void 0!==window.editHandler&&"function"==typeof window.editHandler.saveChapterToIndexedDB?window.editHandler.saveChapterToIndexedDB():console.error("saveChapterToIndexedDB function is not available")});window.indexedDBHelper.initDB("userSettingsDB",1,[{name:"readingSettings",keyPath:"id"},{name:"readingPositions",keyPath:"bookName"}]).then(e=>{settingsDB=e,"undefined"!=typeof initSettings&&initSettings(settingsDB,e=>{"undefined"!=typeof setupSettingsEventListeners&&setupSettingsEventListeners(settingsDB)})}).catch(e=>{console.error("用户设置数据库错误:",e)});const t=new URLSearchParams(window.location.search);bookName=decodeURIComponent(t.get("bookName")),encodedBookName=encodeURIComponent(bookName);const n=document.getElementById("txtTitle");if(n&&(n.textContent=bookName.replace(".txt","")||"txt在线阅读工具"),bookName){const e=[{name:"books",keyPath:"name"}];window.indexedDBHelper.initDB("bookDB",1,e).then(e=>window.indexedDBHelper.getDataByKey("books",encodeURIComponent(bookName))).then(e=>{if(console.log("bookName:",bookName),console.log("bookData:",e?"存在":"不存在"),e)if(void 0!==window.readerFunctions)window.readerFunctions.renderBookContentFromDB(e);else{const t=e.content?"string"==typeof e.content?e.content:e.content.map(e=>e.content).join(""):e;if(chapters=parseChapters(t),renderChapters(chapters),renderContent(chapters),settingsDB){const e=settingsDB.transaction(["readingPositions"],"readonly").objectStore("readingPositions").get(encodeURIComponent(bookName));e.onsuccess=function(){const t=e.result.position;if(t){const{chapterIndex:e,scrollTop:n}=t;highlightChapter(e),content.textContent=chapters[e].content,content.scrollTop=n,updateWordCount(e);const o=chapterList.querySelectorAll("div");o[e]&&(chapterList.scrollTop=o[e].offsetTop-200)}}}}else alert("书籍内容不存在，请重新添加！"),content.textContent="书籍内容不存在，请返回书架重新添加！"}).catch(e=>{console.error("获取文件内容失败:",e)})}});
