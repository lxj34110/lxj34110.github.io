let settingsDB,chapterList,content,currentChapterIndex=0,chapters=[],bookName="",encodedBookName="";function updateChapter(e){highlightChapter(e),content.textContent=chapters[e].content,updateWordCount(e),saveReadingPosition(e,content.scrollTop=0)}function saveReadingPosition(e,t){settingsDB&&bookName&&settingsDB.transaction(["readingPositions"],"readwrite").objectStore("readingPositions").put({bookName:encodedBookName,position:{chapterIndex:e,scrollTop:t}})}function parseChapters(e){var t,n=/^[\s#*$]*(第)?[零一二三四五六七八九十百千1234567890]+章.*$/gm,o=[];let r=0;for(;null!==(t=n.exec(e));)0<o.length&&(o[o.length-1].content=e.slice(r,t.index)),o.push({title:t[0],startIndex:t.index,content:""}),r=t.index;return 0<o.length?o[o.length-1].content=e.slice(r):o.push({title:"章节识别失败",content:e}),o}function renderChapters(e){if(chapters=e,chapterList.innerHTML="",settingsDB){const t=settingsDB.transaction(["readingPositions"],"readonly").objectStore("readingPositions").get(encodedBookName);t.onsuccess=function(){var e=t.result?.position;e&&(highlightChapter(currentChapterIndex=e.chapterIndex),content.textContent=chapters[currentChapterIndex].content,content.scrollTop=e.scrollTop||0,(e=chapterList.querySelectorAll("div"))[currentChapterIndex])&&(chapterList.scrollTop=e[currentChapterIndex].offsetTop-200)}}chapters.forEach((e,t)=>{var n=document.createElement("div");n.textContent=e.title,n.classList.add("chapter-item"),t===currentChapterIndex&&n.classList.add("active"),n.addEventListener("click",()=>{updateChapter(currentChapterIndex=t)}),chapterList.appendChild(n)})}function renderContent(e){0<e.length&&(content.textContent=e[0].content,highlightChapter(0),updateWordCount(0)),content.addEventListener("scroll",debounce(()=>{var e=Array.from(chapterList.querySelectorAll("div")).findIndex(e=>e.classList.contains("active")),e=(-1!==e&&saveReadingPosition(e,content.scrollTop),content.scrollTop+content.clientHeight>=content.scrollHeight-10),t=document.getElementById("chapterButtons");t&&(t.style.display=e?"flex":"none")},300))}function debounce(n,o){let r;return function(){const e=this,t=arguments;clearTimeout(r),r=setTimeout(()=>{n.apply(e,t)},o)}}function highlightChapter(n){chapterList.querySelectorAll("div.chapter-item").forEach((e,t)=>{t===n?e.classList.add("active"):e.classList.remove("active")})}function updateWordCount(e){var e=chapters[e].content.trim().replace(/\s+/g,"").length,t=document.getElementById("chapterWordCount");t&&(t.textContent="字数: "+e)}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("fileInput");chapterList=document.getElementById("chapterList"),content=document.getElementById("content");const n=document.createElement("div"),o=(n.id="progressBar",n.style.cssText=`
      position: absolute;
      left: 0;
      top: 0;
      width: 5px;
      background-color: #007bff;
      height: 0%;
      transition: height 0.1s ease;
      z-index: 100;
    `,content.parentNode.style.position="relative",content.parentNode.appendChild(n),content.addEventListener("scroll",()=>{var e=content.scrollTop,t=content.scrollHeight-content.clientHeight;0!=t&&(e=e/t*100,n.style.height=e+"%")}),document.getElementById("lineHeight")),r=document.getElementById("fontSize"),i=document.getElementById("theme");document.getElementById("settingsToggle").addEventListener("click",()=>{var e=document.querySelector(".settings");e.style.display="none"===e.style.display?"flex":"none"});var e=indexedDB.open("userSettingsDB",1);function a(e){content.style.lineHeight=e.lineHeight,content.style.fontSize=e.fontSize,document.body.className=e.theme}e.onupgradeneeded=function(e){(settingsDB=e.target.result).objectStoreNames.contains("readingSettings")||settingsDB.createObjectStore("readingSettings",{keyPath:"id"}),settingsDB.objectStoreNames.contains("readingPositions")||settingsDB.createObjectStore("readingPositions",{keyPath:"bookName"})},e.onsuccess=function(e){settingsDB=e.target.result;{const t=settingsDB.transaction(["readingSettings"],"readonly").objectStore("readingSettings").get("globalSettings");t.onsuccess=function(){var e=t.result?.settings||{};o.value=e.lineHeight||"1.6",r.value=e.fontSize||"1.125rem",i.value=e.theme||"light",a(e)}}},e.onerror=function(e){console.error("用户设置数据库错误:",e.target.error)},o.addEventListener("change",()=>{var e={lineHeight:o.value,fontSize:r.value,theme:i.value};a(e),settingsDB&&settingsDB.transaction(["readingSettings"],"readwrite").objectStore("readingSettings").put({id:"globalSettings",settings:e})}),r.addEventListener("change",()=>{var e={lineHeight:o.value,fontSize:r.value,theme:i.value};a(e),settingsDB&&settingsDB.transaction(["readingSettings"],"readwrite").objectStore("readingSettings").put({id:"globalSettings",settings:e})}),i.addEventListener("change",()=>{var e={lineHeight:o.value,fontSize:r.value,theme:i.value};a(e),settingsDB&&settingsDB.transaction(["readingSettings"],"readwrite").objectStore("readingSettings").put({id:"globalSettings",settings:e})});e=new URLSearchParams(window.location.search),bookName=decodeURIComponent(e.get("bookName")),encodedBookName=encodeURIComponent(bookName),e=document.getElementById("txtTitle");e&&(e.textContent=bookName.replace(".txt","")||"txt在线阅读工具");const s=document.getElementById("toggleChapters");s&&s.addEventListener("click",()=>{var e,t=document.getElementById("chapterList");t&&(e="none"===t.style.display,t.style.display=e?"block":"none",s.textContent=e?"▥":"▤",e)&&(e=t.querySelector(".active"))&&e.scrollIntoView({behavior:"smooth",block:"nearest"})}),document.getElementById("prevChapter").addEventListener("click",()=>{0<currentChapterIndex&&updateChapter(--currentChapterIndex)}),document.getElementById("nextChapter").addEventListener("click",()=>{currentChapterIndex<chapters.length-1&&updateChapter(++currentChapterIndex)});let t="";const c=document.getElementById("editChapter");var e=document.getElementById("saveChapterEdit"),d=document.getElementById("cancelChapterEdit");const l=document.getElementById("editControls"),g=document.getElementById("editStatus"),p=document.getElementById("content");function u(t,n){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){let e;e=n?`章节内容已保存至:
${t}

提示: 文件已保存到您选择的位置
您可以通过文件管理器查找此文件`:`下载已启动，请检查默认下载文件夹:
${t}

提示: 传统下载方式无法确认保存状态，请确保:
1. 浏览器允许来自此网站的下载
2. 手机存储空间充足
3. 查看浏览器默认下载路径

故障排除:
• 检查浏览器的"下载历史"页面
• 在文件管理器中搜索"${t}"
• 确认浏览器弹出窗口阻止设置未阻止下载
• 尝试使用Chrome浏览器获得更好兼容性`,alert(e)}else alert(`章节内容已保存至默认下载文件夹:${t}

提示: 现代浏览器支持选择保存位置，请使用Chrome、Edge或Firefox最新版本以获得更好体验。`)}c.addEventListener("click",()=>{t=p.textContent,p.contentEditable="true",p.classList.add("editing"),l.style.display="block",g.style.display="block",p.focus(),c.textContent="✍",c.disabled=!0}),d.addEventListener("click",()=>{p.textContent=t,p.contentEditable="false",p.classList.remove("editing"),l.style.display="none",g.style.display="none",c.textContent="✎",c.disabled=!1}),e.addEventListener("click",()=>{chapters[currentChapterIndex].content=p.textContent,updateWordCount(currentChapterIndex),p.contentEditable="false",p.classList.remove("editing"),l.style.display="none",g.style.display="none",c.textContent="编辑章节",c.disabled=!1,async function(){var e=document.getElementById("content");let t=e.innerText;if(t=(t=t.replace(/<br\s*\/?>/gi,"\n").replace(/<div>/gi,"\n").replace(/<\/div>/gi,"")).replace(/<[^>]*>/g,"").trim()){var e=chapters[currentChapterIndex].title.replace(/[\\/:*?"<>|]/g,""),n=new Date,n=""+n.getFullYear()+String(n.getMonth()+1).padStart(2,"0")+String(n.getDate()).padStart(2,"0")+"_"+String(n.getHours()).padStart(2,"0")+String(n.getMinutes()).padStart(2,"0")+String(n.getSeconds()).padStart(2,"0"),e=e+`+${n}.txt`;try{if(window.showSaveFilePicker){var o=await(await window.showSaveFilePicker({suggestedName:e,types:[{description:"Text Files",accept:{"text/plain":[".txt"]}}]})).createWritable();await o.write(t),await o.close(),u(e,!0)}else{var r=new Blob([t],{type:"text/plain;charset=utf-8"});const a=URL.createObjectURL(r),s=document.createElement("a");s.href=a,s.download=e,document.body.appendChild(s);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});s.dispatchEvent(i),setTimeout(()=>{document.body.removeChild(s),URL.revokeObjectURL(a)},5e3),u(e,!1)}}catch(e){console.error("文件保存失败:",e),alert(`文件保存失败: ${e.message}

请尝试以下解决方法:
1. 检查浏览器存储权限
2. 确保手机存储空间充足
3. 手动创建/txt文件夹后重试
4. 确认章节内容不为空`)}}else alert("无法保存空内容，请确保章节有文字内容后重试")}()});var d=document.getElementById("prevChapterBottom"),e=document.getElementById("nextChapterBottom");d&&e&&(d.addEventListener("click",()=>{0<currentChapterIndex&&updateChapter(--currentChapterIndex)}),e.addEventListener("click",()=>{currentChapterIndex<chapters.length-1&&updateChapter(++currentChapterIndex)})),bookName&&((d=indexedDB.open("bookDB",1)).onsuccess=function(e){const o=e.target.result.transaction(["books"],"readonly").objectStore("books").get(encodeURIComponent(bookName));o.onsuccess=function(){var e=o.result?.content;if(console.log("bookName:",bookName),console.log("fileContent:",e?"存在":"不存在"),e){const n=parseChapters(e);if(renderChapters(n),renderContent(n),settingsDB){const o=settingsDB.transaction(["readingPositions"],"readonly").objectStore("readingPositions").get(encodeURIComponent(bookName));o.onsuccess=function(){var e,t=o.result?.position;t&&({chapterIndex:t,scrollTop:e}=t,highlightChapter(t),content.textContent=n[t].content,content.scrollTop=e,updateWordCount(t),(e=chapterList.querySelectorAll("div"))[t])&&(chapterList.scrollTop=e[t].offsetTop-200)}}}else alert("书籍内容不存在，请重新添加！"),content.textContent="书籍内容不存在，请返回书架重新添加！"}},d.onerror=function(e){console.error("获取文件内容失败:",e.target.error)})});
