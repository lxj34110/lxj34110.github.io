let db;function initDB(){const e=indexedDB.open("UserDB",1);e.onupgradeneeded=function(e){if(!(db=e.target.result).objectStoreNames.contains("users")){const e=db.createObjectStore("users",{keyPath:"username"});e.createIndex("password","password",{unique:!1}),createDefaultUsers(e)}},e.onsuccess=function(e){db=e.target.result,checkAndCreateDefaultUsers()},e.onerror=function(e){console.error("IndexedDB初始化错误:",e.target.error)}}function checkAndCreateDefaultUsers(){const e=db.transaction("users","readonly").objectStore("users").count();e.onsuccess=function(){if(0===e.result){createDefaultUsers(db.transaction("users","readwrite").objectStore("users"))}}}function createDefaultUsers(e){const t=new Date,n=`${t.getMonth()+1}`.padStart(2,"0")+`${t.getDate()}`.padStart(2,"0");["admin","system","test","guest"].forEach(t=>{e.add({username:t,password:n})})}function validateLogin(e,t,n){if(["admin","system","test","guest"].includes(e)){const e=new Date;n(t===`${e.getMonth()+1}`.padStart(2,"0")+`${e.getDate()}`.padStart(2,"0"))}else n(!1)}function isLoggedIn(){return null!==sessionStorage.getItem("username")}function logout(){sessionStorage.removeItem("username"),window.location.href="login.html"}document.addEventListener("DOMContentLoaded",initDB),window.auth={validateLogin:validateLogin,isLoggedIn:isLoggedIn,logout:logout},document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("loginForm");e&&e.addEventListener("submit",function(e){e.preventDefault();const t=document.getElementById("username"),n=document.getElementById("password"),o=document.getElementById("error-message"),s=t.value.trim(),r=n.value.trim();s&&r?validateLogin(s,r,function(e){e?(sessionStorage.setItem("username",s),window.location.href="book-shelf.html"):(o.textContent="用户名或密码错误",n.value="")}):o.textContent="用户名和密码不能为空"})});