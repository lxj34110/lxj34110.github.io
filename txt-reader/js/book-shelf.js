document.addEventListener("DOMContentLoaded",()=>{var e=document.getElementById("fileInput");const g=document.getElementById("bookList");document.getElementById("addToBookshelf");let n=new Set,s;var t=indexedDB.open("bookMetadataDB",1);function r(){g.innerHTML="",n.forEach((o,e)=>{var t=document.createElement("div"),n=(t.className="book-card",document.createElement("input")),n=(n.type="checkbox",n.className="delete-checkbox",n.dataset.bookName=o.name,n.addEventListener("click",e=>{e.stopPropagation()}),t.appendChild(n),document.createElement("img")),r=(n.src="../img/book-banner.jpg",n.alt="书籍封面",n.className="book-cover",document.createElement("div")),a=(r.className="book-info",document.createElement("div")),c=(a.className="book-title",a.textContent=o.name,document.createElement("label")),d=(c.className="book-date",new Date(o.lastModified)),s=d.getFullYear().toString(),l=d.getMonth()+1,i=d.getDate(),m=d.getHours().toString().padStart(2,"0"),u=d.getMinutes().toString().padStart(2,"0"),d=d.getSeconds().toString().padStart(2,"0");c.textContent=`☪ ${s}/${l}/${i} ${m}:${u}:`+d,r.appendChild(a),r.appendChild(c),t.appendChild(n),t.appendChild(r),t.dataset.index=e,t.addEventListener("click",async()=>{var e=indexedDB.open("bookDB",1);e.onsuccess=function(e){const t=e.target.result.transaction(["books"],"readonly").objectStore("books").get(encodeURIComponent(o.name));t.onsuccess=function(){var e=t.result?.content;console.log("查询的键:",encodeURIComponent(o.name)),console.log("查询结果:",t.result),e?((e=new URL("txt-reader/page/book-detail.html",window.location.origin)).searchParams.set("bookName",encodeURIComponent(o.name)),window.location.href=e.toString()):alert(`书籍内容不存在，请重新添加！
查询的键: `+encodeURIComponent(o.name))}},e.onerror=function(e){console.error("IndexedDB错误:",e.target.error)}}),g.appendChild(t)})}t.onupgradeneeded=function(e){(s=e.target.result).objectStoreNames.contains("bookMetadata")||s.createObjectStore("bookMetadata",{keyPath:"name"})},t.onsuccess=function(e){const t=(s=e.target.result).transaction(["bookMetadata"],"readonly").objectStore("bookMetadata").getAll();t.onsuccess=function(){var e=t.result||[];n=new Set(e),r()}},t.onerror=function(e){console.error("元数据数据库错误:",e.target.error)},e.addEventListener("change",e=>{Array.from(e.target.files).forEach(async o=>{var e;[...n].some(e=>e.name===o.name)||((e=new FileReader).onload=function(e){const t=e.target.result;e=indexedDB.open("bookDB",1);e.onupgradeneeded=function(e){e=e.target.result;e.objectStoreNames.contains("books")||e.createObjectStore("books",{keyPath:"name"})},e.onsuccess=function(e){e=e.target.result.transaction(["books"],"readwrite");e.objectStore("books").put({name:encodeURIComponent(o.name),content:t}),e.oncomplete=function(){if(n.add({name:o.name,lastModified:o.lastModified,size:o.size,type:o.type}),s){const t=s.transaction(["bookMetadata"],"readwrite").objectStore("bookMetadata");Array.from(n).forEach(e=>{t.put(e)})}r()}},e.onerror=function(e){console.error("IndexedDB错误:",e.target.error)}},e.readAsText(o))})}),r();const o=document.getElementById("allSelected");o.addEventListener("click",()=>{var e=document.querySelectorAll(".delete-checkbox");const t=[...e].every(e=>e.checked);e.forEach(e=>e.checked=!t),o.textContent=t?"批量全选":"取消全选"}),document.getElementById("deleteSelected").addEventListener("click",()=>{var d,e=document.querySelectorAll(".delete-checkbox:checked");const t=Array.from(e).map(e=>e.dataset.bookName);t.forEach(t=>{n.forEach(e=>{e.name===t&&n.delete(e)})}),s?(d=t,new Promise((o,n)=>{const r=s.transaction(["bookMetadata"],"readwrite").objectStore("bookMetadata");let a=0,c=[];d.forEach(t=>{var e=r.delete(t);e.onsuccess=()=>{++a===d.length&&(0<c.length?n(c):o())},e.onerror=e=>{console.error("删除书籍元数据失败: "+t,e.target.error),c.push(e.target.error),++a===d.length&&n(c)}}),0===d.length&&o()}).then(()=>{return d=t,new Promise((a,c)=>{var e=indexedDB.open("bookDB",1);e.onerror=e=>{c(e.target.error)},e.onsuccess=e=>{const o=e.target.result.transaction(["books"],"readwrite").objectStore("books");let n=0,r=[];d.forEach(t=>{var e=encodeURIComponent(t),e=o.delete(e);e.onsuccess=()=>{++n===d.length&&(0<r.length?c(r):a())},e.onerror=e=>{console.error("删除书籍内容失败: "+t,e.target.error),r.push(e.target.error),++n===d.length&&c(r)}}),0===d.length&&a()}});var d}).then(()=>{console.log("所有选中的书籍已成功删除"),r()}).catch(e=>{console.error("删除书籍时出错:",e),r()})):r()})});
