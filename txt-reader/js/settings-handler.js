if(!window.indexedDBHelper){console.error('indexedDBHelper未初始化，请确保在settings-handler.js之前引入indexeddb-helper.js')}function applySettings(settings){document.body.className=settings.theme;const content=document.getElementById('content');if(content){content.style.lineHeight=settings.lineHeight;content.style.fontSize=settings.fontSize}}function initSettings(settingsDB,callback){const stores=[{name:'settingsStore',keyPath:'id'}];window.indexedDBHelper.initDB('readingSettings',1,stores).then(db=>{console.log('readingSettings数据库初始化成功');return window.indexedDBHelper.getDataByKey('readingSettings','settingsStore','globalSettings')}).then(result=>{const savedSettings=result?result.settings:{};const settings={lineHeight:savedSettings.lineHeight||'1.6',fontSize:savedSettings.fontSize||'1.125rem',theme:savedSettings.theme||'light'};applySettings(settings);updateSettingsUI(settings);if(callback)callback(settings)}).catch(error=>{console.error('初始化设置失败:',error);const settings={lineHeight:'1.6',fontSize:'1.125rem',theme:'light'};applySettings(settings);updateSettingsUI(settings);if(callback)callback(settings)})}function updateSettingsUI(settings){const lineHeightSelect=document.getElementById('lineHeight');const fontSizeSelect=document.getElementById('fontSize');const themeSelect=document.getElementById('theme');if(lineHeightSelect&&settings.lineHeight){lineHeightSelect.value=settings.lineHeight}if(fontSizeSelect&&settings.fontSize){fontSizeSelect.value=settings.fontSize}if(themeSelect&&settings.theme){themeSelect.value=settings.theme}}function setupSettingsEventListeners(settingsDB){const lineHeightSelect=document.getElementById('lineHeight');const fontSizeSelect=document.getElementById('fontSize');const themeSelect=document.getElementById('theme');const settingsToggle=document.getElementById('settingsToggle');if(settingsToggle){settingsToggle.addEventListener('click',()=>{const settings=document.querySelector('.settings');if(settings){settings.style.display=settings.style.display==='none'?'flex':'none'}})}if(lineHeightSelect&&fontSizeSelect&&themeSelect){const updateSettings=()=>{const settings={lineHeight:lineHeightSelect.value,fontSize:fontSizeSelect.value,theme:themeSelect.value};applySettings(settings);if(settingsDB){const settingsData={id:'globalSettings',settings:settings};window.indexedDBHelper.updateData('readingSettings','settingsStore',settingsData).catch(error=>{console.error('保存设置失败:',error)})}};lineHeightSelect.addEventListener('change',updateSettings);fontSizeSelect.addEventListener('change',updateSettings);themeSelect.addEventListener('change',updateSettings)}}saveSettings=function(settings){applySettings(settings);const settingsData={id:'globalSettings',settings:settings};if(window.indexedDBHelper){window.indexedDBHelper.updateData('readingSettings','settingsStore',settingsData).then(()=>{console.log('设置保存成功')}).catch(error=>{console.error('保存设置失败:',error)})}else{console.error('indexedDBHelper未初始化，无法保存设置')}};window.applySettings=applySettings;window.initSettings=initSettings;window.saveSettings=saveSettings;window.setupSettingsEventListeners=setupSettingsEventListeners;window.updateSettingsUI=updateSettingsUI;if(typeof module!=='undefined'&&module.exports){module.exports={applySettings,initSettings,saveSettings,setupSettingsEventListeners,updateSettingsUI}}
