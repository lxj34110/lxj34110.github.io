let originalContent="",chapters=[],currentChapterIndex=0;function initEditFunctionality(e,t){chapters=e,currentChapterIndex=t;const n=document.getElementById("editChapter"),o=document.getElementById("saveChapterEdit"),a=document.getElementById("cancelChapterEdit"),d=document.getElementById("recallEdit"),r=document.getElementById("recoverEdit"),i=document.getElementById("editControls"),c=document.getElementById("editStatus"),s=document.getElementById("content");let l=[],p=-1;n&&n.addEventListener("click",()=>{originalContent=s.textContent,s.contentEditable="true",s.classList.add("editing"),i.style.display="block",c.style.display="block",s.focus(),n.textContent="✍",n.disabled=!0,l=[originalContent],p=0,d&&(d.disabled=!0),r&&(r.disabled=!0),s.addEventListener("input",()=>{chapters[currentChapterIndex].content=s.textContent,void 0!==updateWordCount&&updateWordCount(currentChapterIndex),p<l.length-1&&(l=l.slice(0,p+1)),l.push(s.textContent),p=l.length-1,d&&(d.disabled=0===p),r&&(r.disabled=p===l.length-1)})}),a&&a.addEventListener("click",()=>{window.indexedDBHelper.initDB("bookDB",1,[{name:"books",keyPath:"name"}]).then(e=>window.indexedDBHelper.getDataByKey("books",encodeURIComponent(bookName))).then(e=>{if(e&&e.content){if(Array.isArray(e.content))s.textContent=e.content[currentChapterIndex].content,chapters[currentChapterIndex].content=e.content[currentChapterIndex].content;else if("string"==typeof e.content){const t=window.readerFunctions.parseChapters(e.content);s.textContent=t[currentChapterIndex].content,chapters[currentChapterIndex].content=t[currentChapterIndex].content}}else s.textContent=originalContent;s.contentEditable="false",s.classList.remove("editing"),i.style.display="none",c.style.display="none",n.textContent="✎",n.disabled=!1,void 0!==updateWordCount&&updateWordCount(currentChapterIndex)}).catch(e=>{console.error("从indexdb加载内容失败:",e),s.textContent=originalContent,s.contentEditable="false",s.classList.remove("editing"),i.style.display="none",c.style.display="none",n.textContent="✎",n.disabled=!1})}),d&&d.addEventListener("click",()=>{p>0&&(p--,s.textContent=l[p],chapters[currentChapterIndex].content=l[p],void 0!==updateWordCount&&updateWordCount(currentChapterIndex),d.disabled=0===p,r&&(r.disabled=!1))}),r&&r.addEventListener("click",()=>{p<l.length-1&&(p++,s.textContent=l[p],chapters[currentChapterIndex].content=l[p],void 0!==updateWordCount&&updateWordCount(currentChapterIndex),d&&(d.disabled=!1),r.disabled=p===l.length-1)}),o&&o.addEventListener("click",()=>{chapters[currentChapterIndex].content=s.textContent,void 0!==updateWordCount&&updateWordCount(currentChapterIndex),s.contentEditable="false",s.classList.remove("editing"),i.style.display="none",c.style.display="none",n.textContent="✎",n.disabled=!1,saveChapterAsTxt()})}async function saveChapterAsTxt(){let e=document.getElementById("content").innerText;if(!(e=(e=e.replace(/<br\s*\/?>/gi,"\n").replace(/<div>/gi,"\n").replace(/<\/div>/gi,"")).replace(/<[^>]*>/g,"").trim()))return void alert("无法保存空内容，请确保章节有文字内容后重试");const t=chapters[currentChapterIndex].title.replace(/[\\/:*?"<>|]/g,""),n=new Date,o=`${t}+${`${n.getFullYear()}${String(n.getMonth()+1).padStart(2,"0")}${String(n.getDate()).padStart(2,"0")}_${String(n.getHours()).padStart(2,"0")}${String(n.getMinutes()).padStart(2,"0")}${String(n.getSeconds()).padStart(2,"0")}`}.txt`;try{if(window.showSaveFilePicker){const t=await window.showSaveFilePicker({suggestedName:o,types:[{description:"Text Files",accept:{"text/plain":[".txt"]}}]}),n=await t.createWritable();await n.write(e),await n.close(),showSaveNotification(o,!0)}else{const t=new Blob([e],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download=o,document.body.appendChild(a);const d=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});a.dispatchEvent(d),setTimeout(()=>{document.body.removeChild(a),URL.revokeObjectURL(n)},5e3),showSaveNotification(o,!1)}}catch(e){console.error("文件保存失败:",e),alert(`文件保存失败: ${e.message}\n\n请尝试以下解决方法:\n1. 检查浏览器存储权限\n2. 确保手机存储空间充足\n3. 手动创建/txt文件夹后重试\n4. 确认章节内容不为空`)}}function showSaveNotification(e,t){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){let n;n=t?`章节内容已保存至:\n${e}\n\n提示: 文件已保存到您选择的位置\n您可以通过文件管理器查找此文件`:`下载已启动，请检查默认下载文件夹:\n${e}\n\n提示: 传统下载方式无法确认保存状态，请确保:\n1. 浏览器允许来自此网站的下载\n2. 手机存储空间充足\n3. 查看浏览器默认下载路径\n\n故障排除:\n• 检查浏览器的"下载历史"页面\n• 在文件管理器中搜索"${e}"\n• 确认浏览器弹出窗口阻止设置未阻止下载\n• 尝试使用Chrome浏览器获得更好兼容性`,alert(n)}else alert(`章节内容已保存至默认下载文件夹:${e}\n\n提示: 现代浏览器支持选择保存位置，请使用Chrome、Edge或Firefox最新版本以获得更好体验。`)}function updateWordCount(e){const t=chapters[e].content.trim().replace(/\s+/g,"").length,n=document.getElementById("chapterWordCount");n&&(n.textContent=`字数: ${t}`)}function saveChapterToIndexedDB(){if(!bookName||!chapters||0===chapters.length)return void console.error("无法保存章节内容: 缺少必要数据");const e={name:encodeURIComponent(bookName),content:chapters.map(e=>({title:e.title,content:e.content}))};window.indexedDBHelper.initDB("bookDB",1,[{name:"books",keyPath:"name"}]).then(t=>window.indexedDBHelper.updateData("books",e)).then(()=>{console.log("章节内容已保存到IndexedDB"),alert("章节内容已保存到IndexedDB")}).catch(e=>{console.error("保存到IndexedDB失败:",e),alert("保存到IndexedDB失败: "+e.message)})}"undefined"!=typeof module&&module.exports&&(module.exports={initEditFunctionality:initEditFunctionality,saveChapterAsTxt:saveChapterAsTxt,showSaveNotification:showSaveNotification,updateWordCount:updateWordCount,saveChapterToIndexedDB:saveChapterToIndexedDB,chapters:chapters,currentChapterIndex:currentChapterIndex}),"undefined"!=typeof window&&(window.editHandler={initEditFunctionality:initEditFunctionality,saveChapterAsTxt:saveChapterAsTxt,showSaveNotification:showSaveNotification,updateWordCount:updateWordCount,saveChapterToIndexedDB:saveChapterToIndexedDB,chapters:chapters,currentChapterIndex:currentChapterIndex});
